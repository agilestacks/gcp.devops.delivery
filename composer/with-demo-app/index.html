<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Cloud Composer #  Deploy with CloudShell  This sandbox will deploy a Cloud Composer
List of the components used in this sandbox:
 Network Cloud Composer Environment Dataflow Pipeline Example Cloud Storage Bucket BigQuery Table   Note: additional details are available in Cloud Composer Guide
 Configuration #  Before you can deploy the sandbox please run the initialization command pointing to the hub manifest file:
hub stack init -f hub-composer-demo-app."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="With Demo App"><meta property="og:description" content="Cloud Composer #  Deploy with CloudShell  This sandbox will deploy a Cloud Composer
List of the components used in this sandbox:
 Network Cloud Composer Environment Dataflow Pipeline Example Cloud Storage Bucket BigQuery Table   Note: additional details are available in Cloud Composer Guide
 Configuration #  Before you can deploy the sandbox please run the initialization command pointing to the hub manifest file:
hub stack init -f hub-composer-demo-app."><meta property="og:type" content="article"><meta property="og:url" content="http://google.devops.delivery/composer/with-demo-app/"><meta property="article:section" content="composer"><title>With Demo App | GCP Support Sandboxes</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.82c5dbd23447cee0b4c2aa3ed08ce0961faa40e1fa370eee4f8c9f02e0d46b5f.css integrity="sha256-gsXb0jRHzuC0wqo+0Izglh+qQOH6Nw7uT4yfAuDUa18=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script>
<script defer src=/en.search.min.105a36e87c8a51ff3a15e89a0118f29beedbe013e8e16e067f8be5b161db81e5.js integrity="sha256-EFo26HyKUf86FeiaARjym+7b4BPo4W4Gf4vlsWHbgeU=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>GCP Support Sandboxes</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><span>Cloud Composer</span><ul><li><a href=/composer/with-demo-app/ class=active>With Demo App</a></li></ul></li><li><span>Cloud SQL</span><ul><li><a href=/cloud-sql/with-load-test/>With Load Test</a></li></ul></li><li><span>GKE</span><ul><li><a href=/gke/just-gke/>Empty GKE</a></li><li><a href=/gke/with-demo-app/>With Demo App</a></li><li><a href=/gke/anthos-with-demo-app/>ASM with Demo App</a></li></ul></li><li><span>VM</span><ul><li><a href=/vm/php-web-server/>Web Server + PHP + Cloud SQL</a></li></ul></li></ul><ul><li><a href=https://github.com/agilestacks/google-stacks target=_blank rel=noopener>Github</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>With Demo App</strong>
<label for=toc-control></label></div></header><article class=markdown><h1 id=cloud-composer>Cloud Composer
<a class=anchor href=#cloud-composer>#</a></h1><a href="https://ssh.cloud.google.com/cloudshell/editor?cloudshell_image=gcr.io/superhub/cloud-shell&cloudshell_git_repo=https://github.com/agilestacks/google-stacks&cloudshell_tutorial=" target=_blank rel=noopener class=book-btn>Deploy with CloudShell</a><p>This sandbox will deploy a <a href=https://cloud.google.com/composer>Cloud Composer</a></p><p>List of the components used in this sandbox:</p><ul><li><a href=https://github.com/agilestacks/google-components/tree/main/gke-gcloud><code>Network</code></a></li><li><a href=https://github.com/agilestacks/google-components/tree/main/composer-environment><code>Cloud Composer Environment</code></a></li><li><a href=https://github.com/agilestacks/google-components/tree/main/dataflow-example><code>Dataflow Pipeline Example</code></a></li><li><a href=https://github.com/agilestacks/google-components/tree/main/dataflow-example><code>Cloud Storage Bucket</code></a></li><li><a href=https://github.com/agilestacks/google-components/tree/main/dataflow-example><code>BigQuery Table</code></a></li></ul><blockquote><p>Note: additional details are available in <a href=https://cloud.google.com/composer/docs/how-to>Cloud Composer Guide</a></p></blockquote><h2 id=configuration>Configuration
<a class=anchor href=#configuration>#</a></h2><p>Before you can deploy the sandbox please run the initialization command pointing to the <code>hub</code> manifest file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>hub stack init -f hub-composer-demo-app.yaml
</span></span></code></pre></div><p>The command will prompt you to enter the ID of your GCP project.</p><p>Next, please run the following command to configure the environment. You will be prompted for Composer version - use values <code>v1</code> or <code>v2</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>hub stack configure
</span></span></code></pre></div><h3 id=how-to-recover-the-configuration-of-an-existing-sandbox>How to recover the configuration of an existing sandbox?
<a class=anchor href=#how-to-recover-the-configuration-of-an-existing-sandbox>#</a></h3><p>Google Cloud Shell environments are ephemeral,
which means any files stored locally on the Cloud Shell machine will be lost when
the machine restarts.
Luckily, we store sandbox state files in the Cloud,
which means, if we lose a local state, we can always recover it from the Cloud.</p><p>Execute the following commands to recover a state of a sandbox:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>hub stack init -f hub-composer-demo-app.yaml -s <span style=color:#f92672>{</span>GCS path to a state file of the sanbox<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>hub stack configure
</span></span></code></pre></div><p>Please browse GCS buckets in your project to find the right one by the convention below:</p><p>GCS path naming convention:</p><p><em>gs://{sandbox state bucket}/{stack dns name}/hub/hub.state</em></p><p>Example:</p><p><em>gs://superhub-superhub/overconfident-corvo-216.epam.devops.delivery/hub/hub.state</em></p><p>After state is recovered, you can undeploy or update your sandbox.</p><h2 id=deployment>Deployment
<a class=anchor href=#deployment>#</a></h2><p>Once you are done with the configuration, use the following command to deploy a sandbox</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>hub stack deploy
</span></span></code></pre></div><p>If you want to change environemnt configuration and redeploy a composer environment run following command</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>hub stack undeploy -c <span style=color:#e6db74>&#34;composer&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># make a change  now in the configuration or in the body of the component</span>
</span></span><span style=display:flex><span>hub stack deploy -c <span style=color:#e6db74>&#34;composer&#34;</span>
</span></span></code></pre></div><blockquote><p>Note: ieven in minimal configuration it will still take 20+ minutes to redeploy</p></blockquote><p>To delete the sandbox, run the followng command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>hub stack undeploy
</span></span></code></pre></div><h2 id=getting-deployment-result>Getting deployment result
<a class=anchor href=#getting-deployment-result>#</a></h2><p>After successful deployment you will get three URLs</p><ol><li>Airflow URL</li><li>GCS bucket</li><li>GKE Cluster</li></ol><p>You can also find it by running command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>hub show
</span></span></code></pre></div><p>If you want to see only the configuration parameters used by Composer run the following command</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>hub show -c <span style=color:#e6db74>&#34;composer&#34;</span>
</span></span></code></pre></div><h3 id=get-gke-kubeconfig>Get GKE kubeconfig
<a class=anchor href=#get-gke-kubeconfig>#</a></h3><p>Use a query string for</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cluster_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>hub show -q <span style=color:#e6db74>&#39;.parameters.composer.gkeCluster&#39;</span> -- -Mr<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>gcloud container clusters get-credentials <span style=color:#e6db74>&#34;</span>$cluster_name<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># to confirm cluster setup</span>
</span></span><span style=display:flex><span>k cluster-info
</span></span></code></pre></div><p>TODO: we may want to delegate this to the <code>composer</code> component <code>post-deploy</code>. Depends if we bother to deploy on top anything else, (i.e. Ingress Controller, user apps etc as set of components)</p><h2 id=additional-parameters>Additional Parameters
<a class=anchor href=#additional-parameters>#</a></h2><p>Additional parameters can be modified in <code>hub-composer-demo-app.yaml</code> file</p><table><thead><tr><th style=text-align:left>Name</th><th style=text-align:left>Description</th><th style=text-align:left>Default Value</th></tr></thead><tbody><tr><td style=text-align:left><code>gke.nodeCount</code></td><td style=text-align:left>Number of GKE nodes for compose environment. Must be at least <code>3</code></td><td style=text-align:left><code>3</code></td></tr><tr><td style=text-align:left><code>gke.machineType</code></td><td style=text-align:left>Number of GKE nodes for compose environment</td><td style=text-align:left><code>n1-standard-1</code></td></tr><tr><td style=text-align:left><code>composer.version</code></td><td style=text-align:left>Version of composer (<code>v1</code> or <code>v2</code>) when <code>v2</code></td><td style=text-align:left><code>v1</code></td></tr><tr><td style=text-align:left><code>component.network.subnetworkCidr</code></td><td style=text-align:left>Target environment subnet address range</td><td style=text-align:left><code>10.127.0.0/20</code></td></tr></tbody></table><p>You can read about configuration options here: <a href=https://cloud.google.com/composer/docs/how-to/managing/creating>https://cloud.google.com/composer/docs/how-to/managing/creating</a></p><h2 id=see-also>See also
<a class=anchor href=#see-also>#</a></h2><ul><li><a href=https://cloud.google.com/composer/docs/how-to>Cloud Composer Guide</a></li><li><a href=https://cloud.google.com/composer/docs/how-to/managing/creating>Creating Environment</a></li></ul><h2 id=architecture-diagram>Architecture Diagram
<a class=anchor href=#architecture-diagram>#</a></h2><p><img src=/images/composer_diagram.png alt="Composer Sandbox Architecture"></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(n){const e=window.getSelection(),t=document.createRange();t.selectNodeContents(n),e.removeAllRanges(),e.addRange(t)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div></main></body></html>